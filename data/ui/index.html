<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/ui/css/style.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
    <title>OTIN UI</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <h1>OTIN - OneTimeInfo</h1>
    <nav>
    <ul class="tab-list">
        <li class="active" id="tab-login"><a class="tab-control" href="#tab-1">Login</a></li>
        <li class="disabled" id="tab-upload"><a class="tab-control" href="#tab-2">Upload</a></li>
        <li class="disabled" id="tab-list"><a class="tab-control" href="#tab-3">List</a></li>
    </ul>
    </nav>
    <div class="tab-panel active" id="tab-1">
        <section id="content">
            <label for="user">login</label><br>
            <input type="text" name="user" id="user"><br>
            <label for="pass">password</label><br>
            <input type="password" name="pass" id="pass"><br>
            <input type="button" name="submit" value="submit">
            <div id=token-status>status: none</div>
        </section>
    </div><div class="tab-panel" id="tab-2">
        <section id="content">
            <label for="id">id</label>
            <input type="text" name="id" id="id">
            <label for="name">name</label>
            <input type="text" name="name" id="name">
            <label for="descr">descr</label>
            <input type="text" name="descr" id="descr">
            <label for="size">size</label>
            <input type="text" name="size" id="size">
            <label for="as_file">as_file</label>
            <input type="text" name="as_file" id="as_file">
            <label for="created_at">created_at</label>
            <input type="text" name="created_at" id="created_at">
            <label for="delete_at">delete_at</label>
            <input type="text" name="delete_at" id="delete_at">
            <label for="data">data</label>
            <input type="text" name="data" id="data">
        </section>
    </div><div class="tab-panel" id="tab-3">
        <section id="content">
            <input type="button" value="refresh" name="datatable-refresh">
            <table id="tableID" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>name</th>
                        <th>descr</th>
                        <th>size</th>
                        <th>as_file</th>
                        <th>created_at</th>
                        <th>delete_at</th>
                    </tr>
                </thead>
            </table>
        </section>
    </div>

<script>
    window.jQuery || document.write('<script src="/ui/js/jquery-3.6.0.min.js"><\/script>')
    var token = ""

    $(document).ready(function() {
        $("input[name='submit']").click(function() {

            var user = $("input[name='user']").val();
            var pass = $("input[name='pass']").val();

            $.ajax({
                url: "/token",
                type: "GET",
                dataType: "json",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', basicAuth(user, pass))
                },
                success: function(response) {
                    token = response.token
                    console.log(token)
                    $("#token-status").text("status: authorized")
                    $('#tab-upload').removeClass('disabled');
                    $('#tab-list').removeClass('disabled');
                    datatableInit()
                },
                
                error: function() {
                    $("#token-status").text("status: not authorized")
                    $('#tab-upload').addClass('disabled');
                    $('#tab-list').addClass('disabled');
                }
            });
        });
    });

    $('.tab-list').each(function(){
        var $this = $(this);
        var $tab = $this.find('li.active');
        var $link = $tab.find('a');
        var $panel = $($link.attr('href'));
        $this.on('click', '.tab-control', function(e) {
            e.preventDefault();
            var $link = $(this);
            var id = this.hash;
            if (id && !$link.is('.active')) {
                $panel.removeClass('active');
                $tab.removeClass('active');
                $panel = $(id).addClass('active');
                $tab = $link.parent().addClass('active');
            }
        });
    })

    $("input[name='datatable-refresh']").click(function() {
        $.ajax({
            url: "/list",
            type: "GET",
            dataType: "json",
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer '+ token )
            },
            success:  function(data) {
                $('#tableID').DataTable().clear().rows.add(data.data).draw();
            }
        })
    })

    function datatableInit() {
        $.ajax({
            url: "/list",
            type: "GET",
            dataType: "json",
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer '+ token )
            },
            success:  function(data) {
                $('#tableID').DataTable( {
                    //"info": false,
                    //"paging": false,
                    "aaData": data.data,
                    "columns": [
                        { "data": "id" },
                        { "data": "name" },
                        { "data": "descr" },
                        { "data": "size" },
                        { "data": "as_file" },
                        { "data": "created_at" },
                        { "data": "delete_at" }
                    ]
                } )
            }
        })
    }

    function basicAuth(user, password) {
        var token = user + ":" + password;
    
        // Base64 Encoding -> btoa
        var hash = btoa(token); 
    
        return "Basic " + hash;
    }

</script>
</body>
</html>